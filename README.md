# 股权关系分析系统

这是一个基于网络图分析的股权关系可视化和分析系统，可以展示企业间的投资关系，进行中心性分析，检测循环持股关系等。

## 功能特点

1. **图模型基本信息展示**
   - 节点和边的总数统计
   - 被投资最多的实体排名
   - 投资最多的实体排名
   - PageRank中心性排名（精确到小数点后8位）
   - 度中心性排名
   - 循环持股关系检测

2. **投资关系详情分析**
   - 支持公司名称搜索
   - 展示公司的投资方详细信息(包括PageRank值、投资数、被投资数等)
   - 展示公司被投资企业的详情
   - 支持在当前页面内查看投资方详情，无需跳转
   - 精确显示持股比例和投资关系
   - 投资方数据表格支持高亮选中行

3. **股权穿透分析**
   - 三层股权结构清晰展示：上游(投资方)、中游(当前公司)和下游(被投资企业)
   - 每层拥有专门的样式区分，增强可读性
   - 支持将任何公司设置为中心分析对象，实现灵活的股权链分析
   - 显示各层次的持股比例及PageRank值等重要指标
   - 支持折叠/展开各层次的详细信息

## 安装与运行

### 前提条件

- Python 3.7+
- pip包管理器

### 安装依赖

```bash
pip install -r requirements.txt
```

### 运行系统

```bash
python app.py
```

启动后，在浏览器中访问 http://localhost:8888 即可使用系统。

## 使用方法

1. 首页加载后，默认显示"分析概览"标签页，展示图模型的基本统计信息。

2. 在左侧边栏的搜索框中输入公司名称，按下Enter键或点击搜索按钮进行搜索。

3. 从搜索结果中选择一个公司，系统会自动切换到"投资关系详情"标签页，并显示该公司的投资方信息。

4. 在"投资关系详情"标签页中，您可以：
   - 查看所有投资方的详细信息，包括持股比例、PageRank值等
   - 查看公司的被投资企业列表
   - 点击"查看详情"可以在当前页面查看某个投资方的详细信息，包括其他投资关系
   - 点击被投资企业列表中的"查看详情"按钮可以将该企业设为中心查看点

5. 在"股权穿透分析"标签页中，您可以：
   - 点击"生成股权分析报告"按钮获取实时的股权穿透分析
   - 查看上游股权结构（投资方层），了解公司的投资方及相关指标
   - 查看中游企业（当前分析主体），包括基本信息和关键指标
   - 查看下游股权结构（被投资企业层），了解公司投资的企业
   - 点击"设为中心企业"按钮可以将任何相关公司设为新的分析中心
   - 折叠/展开各层的详细信息，灵活查看关心的数据

## 数据结构

系统基于CSV文件构建图模型，CSV应包含以下字段：
- name: 实体名称
- eid: 实体ID（可选）
- type: 实体类型（'P'表示个人，'E'表示企业，'UE'表示境外企业）
- level: 实体层级
- parent_id: 父节点ID
- children: 子节点JSON数据
- percent: 持股比例

## 文件说明

- app.py: Flask应用入口文件
- graph_builder.py: 图模型构建模块
- graph_model.py: 图模型基础分析
- advanced_analysis.py: 高级网络分析
- query_node_neighborhood.py: 节点邻域查询
- templates/: HTML模板目录
- static/: 静态资源目录（CSS、JS等）

## 报告生成脚本

系统提供了多个独立脚本，可直接生成分析报告和可视化输出，无需启动Web界面。这些脚本可以批量处理数据，生成静态报告，适用于定期分析或大规模数据处理场景。

### advanced_analysis.py - 高级网络分析报告

该脚本执行深度网络分析并生成综合报告：

```bash
python advanced_analysis.py
```

**主要功能：**
- 中心性分析：计算并输出度中心性、PageRank中心性、接近中心性、中介中心性和特征向量中心性
- 社区检测：识别并可视化网络中的社区结构
- 循环持股分析：检测股权关系中的循环结构，计算循环控制比例
- 关键控制者分析：识别网络中控制多个实体的关键股东

**输出文件：**
- `outputs/reports/advanced_analysis_report.txt`: 包含详细分析结果的文本报告
- `outputs/images/股权关系社区结构.png`: 社区结构可视化图

### visualize_graph_construction.py - 图构建可视化

该脚本逐步可视化图的构建过程，帮助理解数据如何形成网络：

```bash
python visualize_graph_construction.py
```

**主要功能：**
- 逐行读取CSV数据并动态可视化NetworkX图的构建过程
- 展示节点和边的添加过程，直观展示网络的形成
- 生成图构建统计信息

**参数定制：**
- rows_to_visualize: 限制处理的行数（默认100行）
- pause_duration: 每步可视化的暂停时间（默认0.7秒）
- save_final: 是否保存最终图状态（默认是）

**输出文件：**
- `outputs/images/graph_construction_final.png`: 最终图状态的可视化
- `outputs/reports/graph_construction_stats.txt`: 图构建过程的统计信息

### 投资方查询.py - 特定公司投资关系分析

该脚本可快速查询特定公司的投资关系并生成详细报告：

```bash
# 查询特定公司的投资关系
python 投资方查询.py "公司名称"

# 进行全局共同投资方分析
python 投资方查询.py --global
```

**主要功能：**
- 查询指定公司的上游投资方和下游被投资企业
- 显示投资方的详细画像（类型、PageRank值、度中心性、投资数、被投资数等）
- 展示持股比例信息
- 全局分析模式下，识别存在多个股东共同投资的公司

**适用场景：**
- 快速获取特定公司的投资关系
- 发现复杂投资结构中的共同投资行为
- 从命令行直接生成简洁的投资关系报告

## 技术栈

- 后端: Python, Flask, NetworkX
- 前端: Vue.js, Element UI, Axios
- 数据可视化: Element UI组件 

## 最新优化

- PageRank值显示优化：所有PageRank值统一精确到小数点后8位，确保数值准确可比
- 投资方详情展示优化：在当前页面直接显示投资方详情，避免频繁页面跳转
- 被投资企业功能增强：添加更完整的被投资企业查看功能
- 三层股权穿透设计：全新设计的三层结构，更清晰展示股权关系链
- 交互功能优化：添加"设为中心企业"功能，支持沿着股权链灵活分析 